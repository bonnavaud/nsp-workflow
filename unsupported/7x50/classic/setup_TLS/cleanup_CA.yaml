version: '2.0'

cleanup_CA:
  type: direct

  tags:
    - demo workflow by NOKIA

  workflow_meta:
    title:   Cleanup PKI/CA
    author:  NOKIA DEMO
    signature: 164d361ec1ec016d43a0ea1301dd896a18cd07724a88d9150c3284fddc91d7bd5b73c5e85834c71638735454f7cbc0e90f2f2ecea5b89cb21b3247667308d98eebd735f1d4a12c2f24dab07c0830a8bf5c0868d53a598cb4ed2855f9b8fd4ba0bbf63310190ec91ba8dd105f5d1b2c75b5484c41168dfb6386d6919a76ba75a0dd1b93345cfe56b3088b7c6d04ab272de3e93ed186722291ad78e362986bf75d02fe52aaa4158257dce034c25c7292965f424699fafafe36730c9db780d88e777c301e61541e97029b2c6532c8947751d9e6ea70bf2aa37897e242da52e87f09291bf2f58334adb721f35dd2b612ff8bb39152c32b4a488d7fa8b63f138b66fe
    version: '1.0.0'
    license: BSD-3
    package: SROS Automation
    deprecated: false
    urls:
      homepage: https://github.com/nokia/nsp-workflow/tree/master/unsupported/7x50/classic/setup_TLS
      repository: https://github.com/nokia/nsp-workflow
      bugs: https://github.com/nokia/nsp-workflow/issues
    dependencies:
      platform:
        nspOS: ['19.6']

  output:
    result: done

  output-on-error:
    result: failed

  tasks:
    getEnvironment:
      action: environment
      publish:
        env: '<% task().result %>'
      on-success:
        cleanup

    cleanup:
      action: std.ssh
      input:
        host: '<% $.env.pki_host %>'
        username: '<% $.env.pki_user %>'
        password: '<% $.env.pki_password %>'
        cmd: |
          /opt/nsp/os/jre/bin/keytool -delete -alias mytelemetryca -keystore /opt/nsp/os/ssl/nsp.truststore -storepass '<% $.env.pki_storepass %>'
          cd /opt/nsp/os/ssl/certs
          rm -rf telemetry
          rm /etc/pki/CA/index.txt
          rm /etc/pki/CA/crlnumber
...
