version: '2.0'

setupNE_day0_snmpv3:
  type: direct

  description: SetupNE Day 0 (using SNMPv3)

  tags:
    - demo workflow by NOKIA

  workflow_meta:
    title:   7750SR Device Commissioning with SNMPv3
    author:  NOKIA DEMO
    signature: 952e4360d40f4330339d9175f44542534e798a2fe3800ed418c5029b50cf698dd1a9b0725060b9b87ae2160685713e7ffa0ee4866a9365cdf9c4c78e71d4a0ff46b017eca37b4a0ee2ea40244d211acdab8c15638d0a3a7805fc9fa9efb61889a1c18f28cebec93b422388562b983c46b51dcd9ca3cf41b46bcd12095b3b6ebe52e872e11c40be1feb03858b1f8ec9b9d3b40b7fd13fe2378c2f0020f5508b063f82d0101529bc136ef7533016e603fafe8d42a456ba2e430d9bf88374c0eb3d1362f9d4a7806ed6a479f3f3b3172b4e9a06866a9c9a8044f91d156fae5c7047fd66b8a9efbb0610e40f87c525ea674f601d1632601ba728e7c7d89a16e45aac
    version: '1.0.0'
    license: BSD-3
    package: SROS Automation
    deprecated: false

  input:
    - token_auth:
    - mgmtIP:
    - systemIP:
    - neName:
    - snmpUser: nsp
    - snmpPassword: topSecret

  output:
    result: done

  output-on-error:
    result: failed

  tasks:
    getEnvironment:
      action: environment
      publish:
        env: '<% task().result %>'
      on-success:
        get_engine_id

    get_engine_id:
      action: nsp.sr_cli
      input:
        host: '<% $.mgmtIP %>'
        username: admin
        password: admin
        cmd:
          - show system information | match "Engine ID"
      publish:
        engineId: <% regex(".*\s:\s(.*)").replace(task().result[ "cmd1-show system information | match \"Engine ID\""][1], "\\1") %>
      on-success:
        - password2key

    password2key:
      action: std.ssh
      input:
        host: '<% $.env.mdmServer %>'
        username: '<% $.env.mdmUsername %>'
        password: '<% $.env.mdmPassword %>'
        cmd: |
          sudo -H -u nsp /opt/nsp/mediation/bin/password2key.bash md5 <% $.snmpPassword %> <% $.engineId %>|grep MD5
      publish:
        snmpkey: <% regex("\s*MD5 key:\s+(\S+)\n").replace(task().result, "\\1") %>
      on-success:
        - configure_node_classic

    configure_node_classic:
      action: nsp.sr_cli
      input:
        host: '<% $.mgmtIP %>'
        username: admin
        password: admin
        cmd:
          - configure system name "<% $.neName %>"
          - configure router interface "system" address <% $.systemIP %>/32
          - configure system security ssh preserve-key
          - configure system snmp no shutdown
          - configure system snmp packet-size 9216
          - configure system security snmp access group nspgrp security-model usm security-level privacy read "iso" write "iso" notify "iso"
          - configure system security user <% $.snmpUser %> access snmp
          - configure system security user <% $.snmpUser %> snmp group nspgrp
          - configure system security user <% $.snmpUser %> snmp authentication md5 <% $.snmpkey %> privacy des-key <% $.snmpkey %>
          - configure system netconf no shutdown
          - configure system netconf auto-config-save
          - configure system security user "admin" access console netconf
          - configure system security profile "administrative" netconf base-op-authorization lock
          - admin save
          - configure system management-interface configuration-mode model-driven
          - sleep 1
      publish:
        status: <% task().result %>
      on-success:
        - configure_node_md

    configure_node_md:
      action: nsp.sr_cli
      input:
        host: '<% $.mgmtIP %>'
        username: admin
        password: admin
        cmd:
          - /!md-cli
          - configure private
          - system management-interface yang-modules base-r13-modules false
          - system management-interface yang-modules nokia-modules false
          - system management-interface yang-modules nokia-combined-modules true
          - system management-interface yang-modules openconfig-modules true
          - commit
...
