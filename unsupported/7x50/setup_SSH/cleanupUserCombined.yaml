version: '2.0'

cleanupUserCombined:
  type: direct

  description: Deletes SSH user from all nodes

  tags:
    - demo workflow by NOKIA

  workflow_meta:
    title:   Delete local user from all nodes
    author:  NOKIA DEMO
    signature: 2da7f2cec97f1b92783c3c72d65b2243141615bd8df23764091eff26362125e9b4efd97c8fbd641088aeb98eca57083d829a7206ceb66e9c2958620b237ea7f4bf1901b957a439f8b24227dabfe7d25c23422ea0b05be3ac7ba219e7e523c722627b7f67b32be695f98bbebcd9e60fdd4306eb14ba4a9139c8fd76e76a84019d36ca6141d785bced963e2d84b2b80eb86a6fec0a3331dacbd501bcca546e45b67c7af2c68a6304c9001dc9723f160a846b668be5557d033d6cb3bc1485d98cb5ab54a2c590ed45fbf271718a3a81e854b1b9c61fc94f52aa35e3b88c3c3227fdd8874c17ad8b56ea00e255e277cbcd6c4887d13d3a3edeeb7d3ee435d86a393b
    version: '1.0.0'
    license: BSD-3
    package: SROS Automation
    deprecated: false

  input:
    - token_auth:
    - sshUsername: nspuser
    - concurrency: 1

  output:
    result: done

  output-on-error:
    result: failed

  tasks:
    getHosts:
      action: std.http
      input:
        url: <% locate_nsp("networkElements") %>/v1/networkElements?filter=product='7750 SR'
        method: GET
        verify: False
        headers:
          Content-Type: application/json
          Authorization: Bearer <% $.token_auth %>
      publish:
        neInventory: <% task().result.content.response.data %>
      on-success:
        - deleteSSHUserMDM
        - deleteSSHUserNFMP

    deleteSSHUserMDM:
      with-items: host in <% $.neInventory.where($.sourceType=mdm) %>
      concurrency: <% int($.concurrency) %>
      action: nsp.mdm_cli
      input:
        neId: <% $.host.neId %>
        authorization: Bearer <% $.token_auth %>
        onError: stop
        verify: False
        cmds:
          - /!md-cli
          - configure private
          - system security user-params local-user
          - delete user <% $.sshUsername %>
          - commit
      publish:
        status: <% task().result %>

    deleteSSHUserNFMP:
      with-items: host in <% $.neInventory.where($.sourceType=nfmp) %>
      concurrency: <% int($.concurrency) %>
      action: std.http
      input:
        url: <% locate_nsp("samo_netw") %>/v2/netw/NetworkElement/executeMultiCli/network%3A<% $.host.neId %>
        method: PUT
        verify: false
        headers:
          Accept: 'application/json'
          Content-Type: 'application/json'
          Authorization: 'Bearer <% $.token_auth %>'
        body:
          - configure system security no user <% $.sshUsername %>
          - exit all
      publish:
        status: <% task().result %>

...
