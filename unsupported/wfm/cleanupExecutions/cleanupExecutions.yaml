version: '2.0'

cleanupExecutions:
  description: 'Delete Workflow Executions for house-keeping'
  type: direct

  tags:
    - Blueprint

  input:
    - token_auth: ''
    - rest_gateway_host: ''
    - fromDate: '2019-03-03%2010:00:00'
    - byAge: 3600
    - workFlowName: 'cleanupExecutions'
    - workFlowState: 'ERROR'

  tasks:
    run_get_token:
      action: std.http
      input:
        url: 'https://<% $.rest_gateway_host %>/rest-gateway/rest/api/v1/auth/token'
        method: POST
        verify: False
        headers:
          Content-Type: 'application/json'
          Authorization: 'Basic <% $.token_auth %>'
        body:
          grant_type: 'client_credentials'
      publish:
        token: <% task().result.content.access_token %>
      on-success:
        - get_filter

    get_filter:
      action: std.javascript
      input:
        script: |
          function getQueryFilter() {
          var filter = "";
          if ("<% $.byAge %>" != '') {
          now = new Date();
          d = new Date(now - 1000*<% $.byAge %>);
          filter = "?created_at=lt:"
          filter += d.getUTCFullYear() + "-" + (d.getUTCMonth()+1) + "-" + d.getUTCDate() + "%20";
          filter += d.getUTCHours() + ":" + d.getUTCMinutes() + ":" + d.getUTCSeconds();          
          } else if ("<% $.fromDate %>" != '') {
          filter = "?created_at=lt:<% $.fromDate %>";
          }
          if ("<% $.workFlowName %>" != '') {
          if (filter == '') {
          filter = "?workflow_name=<% $.workFlowName %>";
          } else {
          filter = filter + "&workflow_name=<% $.workFlowName %>";
          }
          }
          if ("<% $.workFlowState %>" != '') {
          if (filter == '') {
          filter = "?state=<% $.workFlowState %>";
          } else {
          filter = filter + "&state=<% $.workFlowState %>";
          }
          }
          return filter;
          }
          return getQueryFilter();
      publish:
          queryfilter: <% task().result %>
      on-success:
        - getFilteredRuns

    getFilteredRuns:
      action: std.http
      input:
        url: 'https://<% $.rest_gateway_host %>:8543/wfm/api/v1/execution<% $.queryfilter %>'
        method: GET
        verify: False
        headers:
          Content-Type: 'application/json'
          Authorization: 'Bearer <% $.token %>'
      publish:
        erroredId:  <% task().result.content.response.data.id %>
      on-success:
       - deleteExecutions    

    deleteExecutions:
      with-items: id in <% $.erroredId %>
      action: std.http
      input:
        url: 'https://<% $.rest_gateway_host %>:8543/wfm/api/v1/execution/<% $.id %>'
        method: DELETE
        verify: False
        headers:
          Content-Type: 'application/json'
          Authorization: 'Bearer <% $.token %>'

      publish:
        resultTest: <% task().result %>
      on-success:
        - revoke_token

    revoke_token:
      action: std.http
      input:
        url: 'https://<% $.rest_gateway_host %>/rest-gateway/rest/api/v1/auth/revocation'
        method: POST
        verify: False
        headers:
          Content-Type: 'application/x-www-form-urlencoded'
          Authorization: 'Basic <% $.token_auth %>'
        body:  'token=<% $.token %>&token_type_hint=token'
      publish:
        result: <% task().result %>

